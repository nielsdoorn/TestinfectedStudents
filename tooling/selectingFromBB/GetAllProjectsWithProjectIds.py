from __future__ import unicode_literals

import sys
import pymysql.cursors
import datetime

from EndBlock import EndBlock
from SelectProjectsByIds import SelectProjectsByIds
from ReconstructionBlock import ReconstructionBlock
from ProjectSizeCheckerBlock import ProjectSizeCheckerBlock
from ProjectCompilationCheckerBlock import ProjectCompilationCheckerBlock

import os
import codecs

sys.stdout = codecs.getwriter('utf8')(sys.stdout)
sys.stderr = codecs.getwriter('utf8')(sys.stderr)

config = {}
config['projects'] = [
   10624827,
   10625208,
   10625397, 
   10615948, 
   10670627, 
   10678319, 
   10678320, 
   10699523, 
   10700048, 
   10702834, 
   10724791, 
   10725611, 
   10747563, 
   10747616, 
   10846158, 
   10846508, 
   10904244, 
   10907857, 
   10926821, 
   10928975, 
   10929974, 
   10930017, 
   10943303, 
   11056796, 
   11072057, 
   11079717, 
   11090945, 
   11117150, 
   11117176, 
   11117178, 
   11117231, 
   11121190, 
   11121215, 
   11121230, 
   10625270, 
   10644322, 
   10645018, 
   10645079, 
   10703238, 
   10703491, 
   10724517, 
   10724770, 
   10725097, 
   10725098, 
   10758168, 
   10941119, 
   10941139, 
   11093010, 
   10624250, 
   10625214, 
   10625215, 
   10644295, 
   10644376, 
   10690159, 
   10698994, 
   10702778, 
   10720345, 
   10723584, 
   10784121, 
   10928341, 
   10933885, 
   10934152, 
   10940548, 
   10940606, 
   10942875, 
   10942893, 
   10943131, 
   10943146, 
   11053100, 
   11053120, 
   11053121, 
   11053170, 
   11053173, 
   11058246, 
   10644200, 
   10644202, 
   10644203, 
   10645020, 
   10670402, 
   10695050, 
   10703355, 
   10703530, 
   10724358, 
   10724865, 
   10783883, 
   10845736, 
   10845849, 
   10847043, 
   10847537, 
   10909299, 
   10920363, 
   10920378, 
   10920427, 
   10920670, 
   11060396, 
   11072631, 
   11087682, 
   11087951, 
   11088031, 
   11098905, 
   11099171, 
   10625212, 
   10625216, 
   10625258, 
   10625306, 
   10710856, 
   10724942, 
   10783604, 
   10847463, 
   10625207, 
   10625209, 
   10645109, 
   10652467, 
   10652938, 
   10658680, 
   10676328, 
   10679957, 
   10682554, 
   10747310, 
   10779113, 
   10864387, 
   10866584, 
   10878941, 
   10889110, 
   10904751, 
   10905151, 
   10907344, 
   10908102, 
   10909783, 
   10922106, 
   10929442, 
   10930128, 
   10935015, 
   11063552, 
   11063578, 
   11063610, 
   11063617, 
   11064203, 
   11118118, 
   10624057, 
   10625210, 
   10643001, 
   10643019, 
   10643022, 
   10644303, 
   10678220, 
   10702110, 
   10702176, 
   10723203, 
   10723341, 
   10723693, 
   10723707, 
   10782132, 
   10839405, 
   10839709, 
   10840129, 
   10847884, 
   10912996, 
   10913309, 
   10913362, 
   11051894, 
   11077810, 
   11072363, 
   11091230, 
   11101441, 
   10641181, 
   10641186, 
   10642562, 
   10642582, 
   10644299, 
   10645096, 
   10645097, 
   10676163, 
   10691055, 
   10691472, 
   10691620, 
   10724647, 
   10735109, 
   10830843, 
   10831392, 
   10831525, 
   10836488, 
   10836566, 
   10836914, 
   11051280, 
   11076865, 
   10625184, 
   10625205, 
   10625211, 
   10644470, 
   10644476, 
   10644637, 
   10645130, 
   10645131, 
   11057620, 
   11058387, 
   11080963, 
   11080984, 
   11091480, 
   11091483, 
   11099524, 
   11104301, 
   11112334, 
   11113779, 
   11120643, 
   11132373, 
   10686419, 
   10694991, 
   10703018, 
   10703382,
   10703844, 
   10774751, 
   10774897, 
   10642730, 
   10642767, 
   10645247, 
   10686215, 
   10698737, 
   10720195, 
   10724674, 
   10725375,
   10779488, 
   10847828, 
   10942984, 
   10943244, 
   11088374, 
   10624198, 
   10644209, 
   10644229, 
   10644264, 
   10644267, 
   10644382, 
   10644405, 
   10644425, 
   10644500, 
   10644508, 
   10644630, 
   10644658, 
   10645058, 
   10645258, 
   10695230, 
   10700299, 
   10702589, 
   10716548, 
   10717534, 
   10724567, 
   10724990, 
   10725142, 
   10783511, 
   10804861, 
   10847633, 
   10936679, 
   10936757, 
   10937166, 
   10937287, 
   10941255, 
   11079626, 
   11079723, 
   11079728, 
   11079876, 
   11080500, 
   11116757 
]
config['start'] = '2017-08-28'
config['end'] = '2017-11-13'

dbusername = os.environ['BBDBUSER']
dbpassword = os.environ['BBDBPASS']

# Connect to the database
connection = pymysql.connect(host='localhost',
                             port=3306,
                             user=dbusername,
                             password=dbpassword,
                             db='blackbox_production',
                             charset='utf8mb4',
                             cursorclass=pymysql.cursors.DictCursor)

try:
    with connection.cursor() as cursor:
        print("Creating the pipelines...")
        
        timestamp = datetime.datetime.now()
        print("Reference time is %s" % timestamp) 
        
        end = EndBlock(-1, "%s_experiments.txt" % timestamp)
        recon = ReconstructionBlock("%s_experiment" % timestamp, end)
        compilechecker = ProjectCompilationCheckerBlock(cursor, config['start'], config['end'], recon)
        filesaggregator = ProjectSizeCheckerBlock(cursor, 0, compilechecker)
        projectsByIdSelection = SelectProjectsByIds(config['projects'], filesaggregator)
        
        print("Starting the processing...")

        projectsByIdSelection.process()
                
        print("Done.")
    
finally:
    connection.close()
